name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write
  actions: read
  checks: write

env:
  DOTNET_VERSION: "8.0.x"

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Verify xray-core binary
        shell: pwsh
        run: |
          if (-not (Test-Path "core/xray.exe")) {
            Write-Error "Missing core/xray.exe in repository. Add xray binary before release build."
            exit 1
          }

      - name: Restore
        run: dotnet restore CorpVPN.sln

      - name: Build (Release)
        run: dotnet build CorpVPN.sln -c Release --no-restore

      - name: Publish single-file
        shell: pwsh
        run: |
          powershell -ExecutionPolicy Bypass -File .\build\Publish.ps1

      - name: Add xray to publish payload
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force artifacts\publish\core | Out-Null
          Copy-Item core\xray.exe artifacts\publish\core\xray.exe -Force

      - name: Upload publish artifact
        uses: actions/upload-artifact@v4
        with:
          name: publish
          path: artifacts/publish
          if-no-files-found: error

  installer:
    needs: build
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download publish artifact
        uses: actions/download-artifact@v4
        with:
          name: publish
          path: artifacts/publish

      - name: Install Inno Setup
        shell: pwsh
        run: |
          choco install innosetup -y --no-progress

      - name: Build installer
        shell: pwsh
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" .\installer\CorpVPN.iss

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: installer
          path: artifacts/installer/CorpVPN-Setup.exe
          if-no-files-found: error

  sign:
    needs:
      - build
      - installer
    runs-on: windows-latest
    if: ${{ secrets.SIGN_PFX_BASE64 != '' && secrets.SIGN_PFX_PASSWORD != '' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download publish artifact
        uses: actions/download-artifact@v4
        with:
          name: publish
          path: artifacts/publish

      - name: Download installer artifact
        uses: actions/download-artifact@v4
        with:
          name: installer
          path: artifacts/installer

      - name: Decode signing certificate
        shell: pwsh
        run: |
          $pfxPath = Join-Path $env:RUNNER_TEMP "codesign.pfx"
          [IO.File]::WriteAllBytes($pfxPath, [Convert]::FromBase64String("${{ secrets.SIGN_PFX_BASE64 }}"))
          "PFX_PATH=$pfxPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Locate signtool
        shell: pwsh
        run: |
          $tool = Get-ChildItem "C:\Program Files (x86)\Windows Kits\10\bin" -Recurse -Filter signtool.exe |
            Where-Object { $_.FullName -match "\\x64\\signtool.exe$" } |
            Sort-Object FullName -Descending |
            Select-Object -First 1
          if (-not $tool) {
            Write-Error "signtool.exe not found on runner."
            exit 1
          }
          $dir = Split-Path -Parent $tool.FullName
          "$dir" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Sign app exe
        shell: pwsh
        run: |
          $timestamp = "${{ secrets.TIMESTAMP_URL }}"
          if ([string]::IsNullOrWhiteSpace($timestamp)) { $timestamp = "http://timestamp.digicert.com" }
          powershell -ExecutionPolicy Bypass -File .\build\Sign.ps1 -File .\artifacts\publish\CorpVPN.Client.exe -PfxPath "$env:PFX_PATH" -PfxPassword "${{ secrets.SIGN_PFX_PASSWORD }}" -TimestampUrl $timestamp

      - name: Sign installer
        shell: pwsh
        run: |
          $timestamp = "${{ secrets.TIMESTAMP_URL }}"
          if ([string]::IsNullOrWhiteSpace($timestamp)) { $timestamp = "http://timestamp.digicert.com" }
          powershell -ExecutionPolicy Bypass -File .\build\Sign.ps1 -File .\artifacts\installer\CorpVPN-Setup.exe -PfxPath "$env:PFX_PATH" -PfxPassword "${{ secrets.SIGN_PFX_PASSWORD }}" -TimestampUrl $timestamp

      - name: Upload signed publish artifact
        uses: actions/upload-artifact@v4
        with:
          name: publish-signed
          path: artifacts/publish
          if-no-files-found: error

      - name: Upload signed installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: installer-signed
          path: artifacts/installer/CorpVPN-Setup.exe
          if-no-files-found: error

  release:
    needs:
      - installer
      - sign
    if: ${{ startsWith(github.ref, 'refs/tags/') && always() }}
    runs-on: windows-latest

    steps:
      - name: Download signed installer
        if: ${{ needs.sign.result == 'success' }}
        uses: actions/download-artifact@v4
        with:
          name: installer-signed
          path: artifacts/release

      - name: Download unsigned installer (fallback)
        if: ${{ needs.sign.result != 'success' }}
        uses: actions/download-artifact@v4
        with:
          name: installer
          path: artifacts/release

      - name: Publish draft GitHub release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          generate_release_notes: true
          files: |
            artifacts/release/CorpVPN-Setup.exe
